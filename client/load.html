<html>

<head>
  <title>Chess Saver</title>
  <link href="default-styles.css" type="text/css" rel="stylesheet" />
  <style>
    header {
      background-color: pink;
      color: yellow;
    }

    h1 {
      font-family: fantasy;
      filter: drop-shadow(5px 5px 2px #4444dd);
    }

    section {
      border-bottom: 1px dashed gray;
    }
    canvas {
      outline: 5px black solid;
    }
  </style>
  <script>
    let canvas;
    let ctx;
    let imgW, imgH;
    const width = 800, height = 800;
    window.onload = init;
    let pieces = new Image();
    pieces.src = "pieces.png";
    let imageLoaded = false;
    let board = new Array(8);
    let fps = 60;
    for (let i = 0; i < 8; i++)
    {
      board[i] = (new Array(8).fill(' '));
    }
    console.table(board);
    pieces.onload = function () { imageLoaded = true; imgW = pieces.width; imgH = pieces.height};
    function init() {
      // Add event listener to load button
      document.querySelector("#load").addEventListener("click", getRandomPosition);
      // board = 
      canvas = document.querySelector('canvas');
      canvas.addEventListener('mousedown', function(e){
        getCursorPosition(canvas,e);
      });
      ctx = canvas.getContext('2d');
      setInterval(resetCanvas, 1000 / fps);

    }

    // color -> 0 is white, 1 is black
    function drawPiece(type, color, x, y )
    {
      switch (type)
      {
        case "k": 
          ctx.drawImage(pieces, 0, color * pieces.height / 2, imgW/6,imgW / 6, x * 100, y * 100,100,100);
          break;
        case "q": 
          ctx.drawImage(pieces, imgW/6 * 1, color * pieces.height / 2, imgW/6,imgW / 6, x * 100, y * 100,100,100);
          break;
        case "b": 
          ctx.drawImage(pieces, imgW/6 * 2, color * pieces.height / 2, imgW/6,imgW / 6, x * 100, y * 100,100,100);
          break;
        case "n": 
          ctx.drawImage(pieces, imgW/6 * 3, color * pieces.height / 2, imgW/6,imgW / 6, x * 100, y * 100,100,100);
          break;
        case "r": 
          ctx.drawImage(pieces, imgW/6 * 4, color * pieces.height / 2, imgW/6,imgW / 6, x * 100, y * 100,100,100);
          break;
        case "p": 
          ctx.drawImage(pieces, imgW/ 6 * 5, color * pieces.height / 2, imgW/6,imgW / 6, x * 100, y * 100,100,100);
          break;
        default: // Board at location is empty
          break;

      }
      
    }

    function drawBoard(size)
    {
      // console.log("drawBoard called");
      ctx.fillStyle = "white";
      let bit = false;
      for (let i = 0; i < 8; i++)
      {
        for (let j = 0; j < 8; j++)
        {
          if (j % 2 == bit) ctx.fillRect(size * i, size * j, size, size);
        }
        bit = !bit;
      }
    }

    function drawPieces()
    {
      // console.log("drawPieces called");
      for (let i = 0; i < board.length; i++)
      {
        for (let j = 0; j < board[i].length; j++)
        {
          drawPiece((board[i][j])[0], Number((board[i][j])[1]), i, j)
        }
      }
    }

    // Function for GETting AJAX info from server
    function getRandomPosition(e)
    {
        // remember that an `Event` object gets passed along every time that an event handler or listener calls a function
        // the `target` property of that event points at the element that sent the event, in this case a button
        console.log(`An element of id=${e.target.id} was clicked!`);

        const URL = "/random-position";
        const xhr = new XMLHttpRequest();
        xhr.onload = handleResponse;
        xhr.open("GET",URL);
        // with XHR, after we open a connection, but before we `send()`, we can set 1 or more HTTP request headers
        // this sin't strictly neccessary because "/random-joke" sends JSON by degault
        xhr.setRequestHeader('Accept', "application/javascript");
        xhr.send();
    }

    const handleResponse = (e) => {
        console.log("e.target = ", e.target); // e.target is `xhr` object
        console.log("e.target.response =", e.target.response); // this is a string of "joke" JSON
        const obj = JSON.parse(e.target.response); // turn it back intp an object
        console.log("obj=",obj);
        // clear last board
        resetBoard();

        // Update the board array with information loaded in
        for (let i = 0; i < obj.length; i++)
        {
          let x = obj[i].col - 1;
          let y = obj[i].row - 1;
          // Always access board in backwards order to get correct visual position
          // Might swap this if it makes things easier to access
          board[x][y] = obj[i].type + "" + Number(obj[i].color==="black");
        }
    };

    function resetCanvas () {
      ctx.clearRect(0,0, 800,800);
      ctx.fillStyle = "gray";
      ctx.fillRect(0, 0, width, height);
      drawBoard(width/8);
      drawPieces();
    }
    function resetBoard() {
      for (let i = 0; i < 8; i++)
      {
        for (let j = 0; j < 8; j++)
        {
          board[i][j] = ' ';
        }
      }
    }

    // Code adapted from online source:
    // https://stackoverflow.com/questions/55677/how-do-i-get-the-coordinates-of-a-mouse-click-on-a-canvas-element/18053642#18053642
    function getCursorPosition(canvas, event) {
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        console.log("x: " + x + " y: " + y);
    }
  </script>
</head>

<body>
  <header>
    <nav>
      <a href = "/">Home</a>
      |
      <span id="current">Load</a>
      |
      <a href = "/save.html">Save</a>
      |
      <a href = "/admin.html">Admin</a>
      
    </nav>
    <h1>Click Button to LOAD a random chess position!</h1>
  </header>
  <button id="load">Get Random Saved Position</button>
  <button id="saved">Get Saved Position by Title (not working)</button>
  <br>
  <canvas id="canvas" width="800" height="800"></canvas>
</body>

</html>