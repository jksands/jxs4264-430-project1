<html>

<head>
  <title>Chess Saver</title>
  <link href="default-styles.css" type="text/css" rel="stylesheet" />
  <style>
    canvas {
      outline: 5px black solid;
    }

    .right {
      float: right;
      clear: left;
      width: 50%;
    }

    #buttons button {
      width: 150px;
      height: 100px;
    }
  </style>
  <script>
    let canvas;
    let ctx;
    let imgW, imgH;
    const width = 800, height = 800;
    window.onload = init;
    let pieces = new Image();
    pieces.src = "pieces.png";
    let imageLoaded = false;
    let board = new Array(8);
    let fps = 60;
    let activePiece = 'p';
    let activeColor = 0;

    let div;
    let buttons;
    let mouseX = 0;
    let mouseY = 0;
    for (let i = 0; i < 8; i++) {
      board[i] = (new Array(8).fill(' '));
    }
    pieces.onload = function () { imageLoaded = true; imgW = pieces.width; imgH = pieces.height };

    function init() {
      // Hold execution until image loads
      while (!imageLoaded) {
        // WAIT
      }

      // board = 
      canvas = document.querySelector('canvas');
      canvas.addEventListener('mousedown', function (e) {
        getCursorPosition(canvas, e);
      });
      canvas.addEventListener('mousemove', function (e) {
        mouseX = e.x;
        mouseY = e.y;
      });
      ctx = canvas.getContext('2d');

      div = document.querySelector('#buttons');
      buttons = div.querySelectorAll('button');
      for (let i = 0; i < buttons.length; i++) {
        buttons[i].addEventListener('click', function (e) {
          if (Number(e.target.id) >= 0) {
            activeColor = Number(e.target.id);
          }
          else if (e.target.id === "c") {
            // Call clear logic
            resetBoard();
          }
          else {
            activePiece = e.target.id;
            console.log(activePiece);
          }
        });
      }
      let temp = document.querySelector('#nameForm');
      temp.onsubmit = sendPost;
      setInterval(resetCanvas, 1000 / fps);

    }

    const handleResponse = (e) => {
    const xhr = e.target;
    const content = document.querySelector('h1');
    
    switch(xhr.status){
      case 200:
        content.innerHTML = '<b>Success!</b>';
        break;
      case 201:
        content.innerHTML = '<b>Created!</b>';
        break;
      case 204:
        content.innerHTML = '<b>Updated (No Content)!</b>';
        break;
      case 400:
        content.innerHTML = '<b>Bad Request!</b>';
        break;
      default:
        content.innerHTML = '<b>Error code not implemented by client</b>';
    }
    
    // make sure that something is in the .response property first!
    const obj = xhr.response && JSON.parse(xhr.response);
    console.dir(obj);
    if(obj.id){
      content.innerHTML += `<p>id = ${obj.id}</p><p>message =NULL</p>`;
    }
  };

    const sendPost = (e) => {
      console.log("Submit pressed");
      // "kill" the default behavior of the form (reloading the page it's on)
      e.preventDefault();

      const nameForm = e.target;
      // pull the `action` and `method` from the form (we could have just hard-coded these)
      const nameAction = "/save-position";
      const nameMethod = "POST";


      // Gather board data
      let boardData = [];
      let dataCount = 0;
      for (let i = 0; i < 8; i++) {
        for (let j = 0; j < 8; j++) {
          // If there's a piece here
          if (board[i][j] != ' ')
          {
            // Create an object with requisite data
            boardData[dataCount] = {
              type: board[i][j][0],
              color: Number(board[i][j][1]) === 0 ? 'white' : 'black',
              row: j + 1,
              col: i + 1
            }
            dataCount++;
          }
        }
      }

      boardData = JSON.stringify(boardData);
      console.log(boardData);
      

      const nameField = nameForm.querySelector("#nameField");

      const formData = `name=${nameField.value}&data=${boardData}`;

      const xhr = new XMLHttpRequest();
      xhr.onload = handleResponse;
      xhr.open(nameMethod, nameAction); // NEW - in the past we've been using "GET"
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.send(formData);

      return false; // prevents event bubbling
    };


    // color -> 0 is white, 1 is black
    function drawPiece(type, color, x, y) {
      switch (type) {
        case "k":
          ctx.drawImage(pieces, 0, color * pieces.height / 2, imgW / 6, imgW / 6, x, y, 100, 100);
          break;
        case "q":
          ctx.drawImage(pieces, imgW / 6 * 1, color * pieces.height / 2, imgW / 6, imgW / 6, x, y, 100, 100);
          break;
        case "b":
          ctx.drawImage(pieces, imgW / 6 * 2, color * pieces.height / 2, imgW / 6, imgW / 6, x, y, 100, 100);
          break;
        case "n":
          ctx.drawImage(pieces, imgW / 6 * 3, color * pieces.height / 2, imgW / 6, imgW / 6, x, y, 100, 100);
          break;
        case "r":
          ctx.drawImage(pieces, imgW / 6 * 4, color * pieces.height / 2, imgW / 6, imgW / 6, x, y, 100, 100);
          break;
        case "p":
          ctx.drawImage(pieces, imgW / 6 * 5, color * pieces.height / 2, imgW / 6, imgW / 6, x, y, 100, 100);
          break;
        default: // Board at location is empty
          break;

      }

    }


    function addPiece(type, color, x, y) {
      console.log(type);
      board[x][y] = type + "" + color;
    }

    function drawBoard(size) {
      // console.log("drawBoard called");
      ctx.fillStyle = "white";
      let bit = false;
      for (let i = 0; i < 8; i++) {
        for (let j = 0; j < 8; j++) {
          if (j % 2 == bit) ctx.fillRect(size * i, size * j, size, size);
        }
        bit = !bit;
      }
    }

    function drawPieces() {
      // console.log("drawPieces called");
      for (let i = 0; i < board.length; i++) {
        for (let j = 0; j < board[i].length; j++) {
          drawPiece((board[i][j])[0], Number((board[i][j])[1]), i * 100, j * 100)
        }
      }
    }

    function resetCanvas() {
      // console.log("ACTIVE PIECE: " + activePiece );
      ctx.clearRect(0, 0, 800, 800);
      ctx.fillStyle = "gray";
      ctx.fillRect(0, 0, width, height);
      drawBoard(width / 8);
      drawPieces();
      // draw piece that follows the mouse
      drawPiece(activePiece, activeColor, mouseX, mouseY);
      // console.log(mouseX + "," + mouseY);
    }
    function resetBoard() {
      for (let i = 0; i < 8; i++) {
        for (let j = 0; j < 8; j++) {
          board[i][j] = ' ';
        }
      }
    }

    // Code adapted from online source:
    // https://stackoverflow.com/questions/55677/how-do-i-get-the-coordinates-of-a-mouse-click-on-a-canvas-element/18053642#18053642
    function getCursorPosition(canvas, event) {
      const rect = canvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      console.log("x: " + Math.floor(x / 100) + " y: " + Math.floor(y / 100) + "," + activePiece + "," + activeColor);
      console.log("ADDING PIECE:" + activePiece);
      addPiece(activePiece, activeColor, Math.floor(x / 100), Math.floor(y / 100))
    }
  </script>
</head>

<body>
  <header>
    <nav>
      <a href = "/">Home</a>
      |
      <a href = "/load.html">Load</a>
      |
      <span id="current">Save</a>
      |
      <a href = "/admin.html">Admin</a>
      
    </nav>
    <h1>CONTENT</h1>
  </header>

  <canvas id="canvas" width="800" height="800"></canvas>
  <div id="buttons" class="right">
    <p>PIECES</p>
    <button id="k">KING</button>
    <button id="q">QUEEN</button>
    <br>
    <button id="r">ROOK</button>
    <button id="b">BISHOP</button>
    <br>
    <button id="n">KNIGHT</button>
    <button id="p">PAWN</button>
    <br>
    <button id="-">DELETE</button>
    <button id="c">CLEAR</button>
    <br>
    <p>COLOR</p>
    <button id="0">WHITE</button>
    <button id="1">BLACK</button>
  </div>
  <br>
  <br>
  <form id="nameForm">
    <label for="name">NAME</label>
    <input type="text" id="nameField" name="name"><br><br>
    <input id="nameForm" type="submit" value="Submit">
  </form>

</body>

</html>